#include <stdio.h>
#include <stdlib.h>
#include <locale.h>
#include <string.h>
#include <time.h>

int login();
int menu_perfil_1();
int menu_perfil_2();
void menu_01(nome_pasta);
void menu_02(nome_pasta);
void menu_03(nome_pasta);
void menu_04(nome_pasta);
void menu_05(nome_pasta);
void cabecalho();
void escreve_BD(info, nome_arq);
void fim_lancamento(nome_arq);

void main() {

    setlocale(LC_ALL, "Portuguese");

    int codigo = 1;
    int permissao;
    char nome_pasta[30];
    int mes, ano;
    char teste;
    char nome_arq[30], cria_pasta[30];

    permissao = login();

    switch(permissao){
        case 1:
            cabecalho();
            printf("Digite o mês que deseja trabalhar: \n");//VALIDAR
            scanf("%d", &mes);
            printf("Digite o ano que deseja trabalhar: \n");//VALIDAR
            scanf("%d", &ano);
            sprintf(nome_pasta, "%d-%d", ano, mes);
            sprintf(cria_pasta, "mkdir %s", nome_pasta);
            system(cria_pasta);
            system("cls");
        while(codigo != 0){
            codigo = menu_perfil_1();
            switch(codigo){
                case 1:
                    menu_01(nome_pasta);
                    system("cls");
                    break;
                case 2:
                     menu_02(nome_pasta);
                     system("cls");
                     break;
                case 3:
                    menu_03(nome_pasta);
                    system("cls");
                    break;
                case 4:
                    menu_04(nome_pasta);
                    system("cls");
                case 5:
                    menu_05(nome_pasta);
                    system("cls");
                case 0:
                    break;
                default:
                    printf("Escreva uma opção válida\n");
                    system("cls");
            }
        }
        break;
        case 2:
        while(codigo != 0){

            codigo = menu_perfil_2();

            switch(codigo){
                case 1:
                    menu_03();
                    system("cls");
                    break;
                case 0:
                    break;
                default:
                    printf("Escreva uma opção válida\n");
                    system("cls");
            }
        }
        break;
    }
return;
}


int login(){

    int login;
    int senha;
    int i = 1;
    int permissao;

    cabecalho ();
    printf ("Seja bem-vindo (a)!\n");
    do{
    printf ("Digite seu login: \n");
    scanf ("%i", &login);

    printf ("Digite sua senha: \n");
    scanf ("%i", &senha);

        if (login == 123 && senha == 123){
            printf ("Login feito com sucesso!\n");
            system("cls");
            permissao = 1;
            i = 0;
        }
        else if(login == 456 && senha == 456){
            printf ("Login feito com sucesso!\n");
            system("cls");
            permissao = 2;
            i = 0;
        }
        else{
            system("cls");
            printf ("Usuário nao cadastrado! Tente novamente\n");
        }
    }while(i!=0);
return(permissao);
}

int menu_perfil_1(){
    int codigo;
    cabecalho();
    printf ("Bem-vindo(a)! Escolha uma das opções abaixo para prosseguir:\n");
    printf ("1 - Lançar Gastos\n");
    printf ("2 - Lançar Limite de Verba\n");
    printf ("3 - Consultar Limite Disponivel\n");
    printf ("4 - Consultar Lançamentos\n");
    printf ("5 - Alterar Lançamentos\n");
    printf ("0 - Sair\n");
    printf("Codigo: ");
    scanf ("%i", &codigo);

    system("cls");
    cabecalho();

    return (codigo);
}

int menu_perfil_2(){
    int codigo;
    cabecalho();
    printf ("Bem-vindo(a)! Escolha uma das opções abaixo para prosseguir:\n");
    printf ("1 - Consulta de Limite Disponivel\n");
    printf ("0 - Sair\n");
    printf("Codigo: ");
    scanf ("%i", &codigo);

    system("cls");
    cabecalho();

    return (codigo);
}

void menu_01(nome_pasta){
    //Funcao para lancar gastos no BD

    char nome_arq[30];
    int categoria, documento, dia;
    float valor;
    char descricao[100], favorecido[50], info[100] = "", data[11];

    //CATEGORIA
    printf ("Insira as informacoes solicitadas abaixo: \n");
    printf ("Categoria:\n");
    printf ("1 – RH\n");
    printf ("2 – Encargos Sociais\n");
    printf ("3 – Fundo Reserva\n");
    printf ("4 - Alimentação\n");
    printf ("5 – Material Pedagógico\n");
    printf ("6 – Concessionária\n");
    printf ("7 – Oficineiro\n");
    printf ("8 – Outras Despesas\n");
    scanf("%i", &categoria);

    sprintf(nome_arq, "%s\\%i.txt", nome_pasta,categoria);

    escreve_BD(info, nome_arq);

    sprintf(info, "%i", categoria);
    escreve_BD(info, nome_arq);
    system("cls");
    cabecalho();

    //DATA
    printf ("Dia do Documento\n");
    scanf("%d", &dia);
    sprintf(info, "%d", dia);
    escreve_BD(info, nome_arq);
    system("cls");
    cabecalho();

    //NUMERO DO DOCUMENTO
    printf ("Número do Documento \n ");
    scanf("%i", &documento);
    sprintf(info, "%i", documento);
    escreve_BD(info, nome_arq);
    system("cls");
    cabecalho();

    //DESCRICAO
    printf ("Descrição \n ");
    scanf(" %[^\n]", descricao);
    strcpy(info, descricao);
    escreve_BD(info, nome_arq);
    system("cls");
    cabecalho();

    //FAVORECIDO
    printf ("Nome do Favorecido \n");
    scanf(" %[^\n]", favorecido);
    strcpy(info, favorecido);
    escreve_BD(info, nome_arq);
    system("cls");
    cabecalho();

    //VALOR
    printf ("Valor\nR$");
    scanf("%f", &valor);
    sprintf(info, "%f", valor);
    escreve_BD(info, nome_arq);
    system("cls");
    fim_lancamento(nome_arq);

    return;
}

void menu_02(nome_pasta){
    // Funcao para lancar verbas recebidas
    char nome_arq[30];
    int opcao2, dia1, mes1, ano1, categoria;
    float valor2;
    char info[100];

    sprintf(nome_arq, "%s\\verbas.txt", nome_pasta);
    //Apaga o conteudo da pasta
    FILE* fp;
    fp = fopen(nome_arq, "w");

    char descr_categorias[8][30] = {"1 – RH\n", "2 - Encargos Sociais\n", "3 – Fundo Reserva\n", "4 - Alimentação\n",
    "5 – Material Pedagógico\n", "6 – Concessionária\n", "7 – Oficineiro\n", "8 – Outras Despesas\n"};

    //Lanca as verbas no BD
    for(int i = 0; i<8; i++){

        printf("%s", descr_categorias[i]);
        categoria = i+1;
        sprintf(info, "%i", categoria);
        escreve_BD(info, nome_arq);
        system("cls");
        cabecalho();

        printf("%s", descr_categorias[i]);
        printf("Valor\nR$");
        scanf("%f", &valor2);
        sprintf(info, "%f", valor2);
        escreve_BD(info, nome_arq);
        system("cls");

        fim_lancamento(nome_arq);
    }
return;
}

void menu_03(nome_pasta){
    // Verifica a verba disponivel por categoria
    float valor_gasto, valor_disponivel, valor;

    char descr_categorias[8][30] = {"1 – RH\n", "2 - Encargos Sociais\n", "3 – Fundo Reserva\n", "4 - Alimentação\n",
    "5 – Material Pedagógico\n", "6 – Concessionária\n", "7 – Oficineiro\n", "8 – Outras Despesas\n"};

    char linha[200];
    char *resultado;
    char *pch;
    int categoria;

    char nome_arq[50], nome_arq2[50];

    printf("Gastos Mensais por Categoria:");

    for(int j = 0; j <=7; j++){
        sprintf(nome_arq, "%s\\%i.txt", nome_pasta,j+1);
        FILE* fp;
        fp = fopen(nome_arq, "r");

        while (!feof(fp)){
            resultado = fgets(linha, 100, fp);
            if (resultado){
                pch = strtok (linha,"|");
                int i = 0;
                while (pch != NULL){
                    if(i%5 == 0 && i!= 0){
                        valor = atoi(pch);
                        valor_gasto = valor_gasto+valor;
                    }
                    i++;
                    pch = strtok (NULL, "|");
                }
            }
        }

        printf("\n%s ----------------------------------- Valor Gasto: R$%f\tValor Disponível: R$%f\n",
            descr_categorias[j], valor_gasto);
            valor_gasto = 0.0;
    }
        system("pause");
        system("cls");
return;
}

void menu_04(nome_pasta){
    //Apresenta os lançamentos realizados
    char nome_arq[30];
    char titulo[6][15] = {"Categoria: ", "Dia: ", "Numero: ", "Descrição: ", "Nome: ", "Valor: R$"};
    char info;
    int i;

    printf("Lançamentos realizados:\n");

    for(int j = 1; j <=8; j++){
        sprintf(nome_arq, "%s\\%i.txt", nome_pasta,j);
        FILE* fp;
        fp = fopen(nome_arq, "r");

        i = 0;
        while ((info = getc(fp)) != EOF){
            if(info == '|'){
                printf("\n");
                printf("%s", titulo[i]);
                if(i<=5){
                    i++;
                }else{
                    i = 0;
                }
            }else{
                putchar(info);
            }
        }
        fclose(fp);
    }
    system("pause");


return;
}

void menu_05(nome_pasta){
    //Altera lançamentos realizados

return;
}

void cabecalho(){
    //Cabecalho do Sistema
    printf("************************************");
    printf("\nSISTEMA DE GESTAO DE VERBAS PUBLICAS");
    printf("\n************************************\n");
return;
}

void escreve_BD(info, nome_arq){
    //Escreve as informacoes digitadas no BD
    FILE* fp;
    fp = fopen(nome_arq, "a");
    fprintf(fp, "%s", info);
    fprintf(fp, "|");
    fclose(fp);
return;
}

void fim_lancamento(nome_arq){
    //Termina uma linha de lancamento
    FILE* fp;
    fp = fopen(nome_arq, "a");
    fprintf(fp, "\n");
    fclose(fp);
return;
}
